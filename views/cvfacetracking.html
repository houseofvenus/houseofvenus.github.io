<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Gray Scale Video Stream Transformer OpenCV.js</title>
    <!--<script src="../js/require.js" type="text/javascript"></script>
    --><script src="../js/utils.js" type="text/javascript"></script>
    <script type="text/javascript">
        function onOpenCvReady() {
            console.log("cv is ready");
        }
    </script>
    <script src="../js/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function(){
            cv['onRuntimeInitialized']= function(){
                // do all your work here
                document.getElementById('status').innerHTML = 'OpenCV.js is ready. Please load camera stream.';
                let video = document.getElementById("videoInput"); // video is the id of video tag
                navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                    .then(function(stream) {
                        video.srcObject = stream;
                        video.play();
                    })
                    .catch(function(err) {
                        console.log("An error occurred! " + err);
                    });
                let streaming = true;

                //let video = document.getElementById('videoInput');
                let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
                let dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);
                let gray = new cv.Mat();
                let cap = new cv.VideoCapture(video);
                let faces = new cv.RectVector();
                let classifier = new cv.CascadeClassifier();
                //console.log(cv);
                //let utils = new Utils('errorMessage');
                let faceCascadeFile = 'D:\opencv\data\haarcascades\haarcascade_frontalface_default.xml'; // path to xml
                
                classifier.load(faceCascadeFile);//'../js/haarcascade_frontalface_default.xml'
                

                // use createFileFromUrl to "pre-build" the xml
                
                let util = Utils("error-output");
                
                const FPS = 30;
                function processVideo() {
                    try {
                        if (!streaming) { // TODO: add a button to toggle and clean up the imagery (START/STOP)
                            // clean and stop.
                            src.delete();
                            dst.delete();
                            gray.delete();
                            faces.delete();
                            classifier.delete();
                            streaming = false;
                            return;
                        }
                        let begin = Date.now();
                        // start processing.
                        cap.read(src);
                        src.copyTo(dst);
                        cv.cvtColor(dst, gray, cv.COLOR_RGBA2GRAY, 0);
                        
                       /* util.createFileFromUrl(faceCascadeFile, faceCascadeFile, () => {
                            classifier.load(faceCascadeFile); // in the callback, load the cascade from file 
                        });/**/
                        classifier.detectMultiScale(gray, faces, 1.1, 3, 0);
                        
                        cv.imshow('canvasOutput', gray);
                        // schedule the next one.
                        let delay = 1000/FPS - (Date.now() - begin);
                        setTimeout(processVideo, delay);
                    } catch (err) {
                        //console.log(err);
                        util.printError(err);
                        //Utils("error-output").printError(err);
                        //Utils.printError(err);
                    }
                };

                // schedule the first one.
                setTimeout(processVideo, 0);

              };
        })
    </script>
</head>
<body>
    <h2>Welcome to the OpenCV image loader module</h2>
    <p id="status">OpenCV.js is loading...</p>
    <div>
        <div class="inputoutput">
            <video height="360" width="480" id="videoInput"></video>
        </div>
        <div class="inputoutput">
            <canvas id="canvasOutput" ></canvas>
            <div class="caption">canvasOutput</div>
            <div id="error-output">canvasOutput</div>
        </div>
    </div>
</body>
</html>